name: CI

on:
  push:
    branches:
      - "*"
    paths-ignore:
      - "./static/**"
  pull_request:
    branches:
      - "*"
    paths-ignore:
      - "./static/**"
  pull_request_review:
  workflow_dispatch:

jobs:
  lmp-build:
    runs-on: ubuntu-18.04

    steps:
      - uses: actions/checkout@v2
      
      # go
      - name: Setup Go environment
        uses: actions/setup-go@v2.1.3
        with:
          go-version: '1.16'
      
      - name: make lmp
        run: |
          cd eBPF_Visualization/eBPF_server
          make all

  sidecar-build-and-test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3

      - name: Set up Go
        uses: actions/setup-go@v3
        with:
          go-version: 1.18
      
      - name: Build BCC
        run: |
          set -x
          sudo apt-get update
          # Use release 9 of llvm etc. - later versions have an unfixed
          # bug on Ubuntu:
          # https://github.com/iovisor/bcc/issues/2915
          sudo apt-get -y install bison build-essential cmake flex git libelf-dev libfl-dev libedit-dev libllvm9 llvm-9-dev libclang-9-dev python zlib1g-dev
          pushd /tmp
          git clone --depth 1 --branch v0.20.0 https://github.com/iovisor/bcc.git
          mkdir -p bcc/build; cd bcc/build
          # Symlink /usr/lib/llvm to avoid "Unable to find clang libraries"
          # The directory appears only to be created when installing the
          # virtual llvm-dev package.
          # https://github.com/iovisor/bcc/issues/492
          sudo ln -s /usr/lib/llvm-9 /usr/local/llvm
          cmake ..
          make
          sudo make install

      - name: Build
        run: |
          cd eBPF_Supermarket/sidecar/
          go build -v ./...
      - name: Test
        run: |
          cd eBPF_Supermarket/sidecar/
          go test `go list ./... | grep -v github.com/eswzy/podstat/tools`

  sidecar-integration-test-with-minikube-and-istio:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3

      - name: Set up Go
        uses: actions/setup-go@v3
        with:
          go-version: 1.18

      - name: Start minikube
        id: minikube
        uses: medyagh/setup-minikube@master

      - name: Set Up istio
        run : |
          # https://istio.io/latest/docs/setup/getting-started/
          curl -L https://istio.io/downloadIstio | sh -
          cd istio-1.14.1
          export PATH=$PWD/bin:$PATH
          istioctl install --set profile=demo -y
          kubectl label namespace default istio-injection=enabled
          kubectl apply -f samples/bookinfo/platform/kube/bookinfo.yaml
      
      - name: Build BCC
        run: |
          set -x
          sudo apt-get update
          # Use release 9 of llvm etc. - later versions have an unfixed
          # bug on Ubuntu:
          # https://github.com/iovisor/bcc/issues/2915
          sudo apt-get -y install bison build-essential cmake flex git libelf-dev libfl-dev libedit-dev libllvm9 llvm-9-dev libclang-9-dev python zlib1g-dev
          pushd /tmp
          git clone --depth 1 --branch v0.20.0 https://github.com/iovisor/bcc.git
          mkdir -p bcc/build; cd bcc/build
          # Symlink /usr/lib/llvm to avoid "Unable to find clang libraries"
          # The directory appears only to be created when installing the
          # virtual llvm-dev package.
          # https://github.com/iovisor/bcc/issues/492
          sudo ln -s /usr/lib/llvm-9 /usr/local/llvm
          cmake ..
          make
          sudo make install

      - name: Wait for istio
        run: |
          kubectl get nodes
          kubectl get pods -owide -A
          kubectl get services
          test_pod() {
            while [[ $(kubectl get pods -l $1 -o 'jsonpath={..status.conditions[?(@.type=="Ready")].status}') != "True" ]]
              do 
                echo "waiting for pod"
                sleep 5
                kubectl get pods -owide -A; 
              done
            return 0
          }
          test_pod app=ratings
          echo "ratings is done"
          test_pod app=productpage
          echo "productpage is done"
          kubectl exec "$(kubectl get pod -l app=ratings -o jsonpath='{.items[0].metadata.name}')" -c ratings -- curl -sS productpage:9080/productpage | grep -o "<title>.*</title>"

      - name: Run
        run: |
          export MINIKUBE_STARTED=TRUE
          eval $(minikube -p minikube docker-env)
          env
          docker ps -a
          ps axjf
          cd eBPF_Supermarket/sidecar/
          go run main.go
